package main

import (
	"<%= appSlug %>-backend/internal/handlers"
	"os"

	"github.com/joho/godotenv"
	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

func main() {
	godotenv.Load()

	e := echo.New()

	// Middleware
	e.Use(middleware.Logger())
	e.Use(middleware.Recover())
	// CORS configuration - allow only the configured frontend URL
	allowedOrigins := []string{}
	if frontendURL := os.Getenv("FRONTEND_URL"); frontendURL != "" {
		allowedOrigins = append(allowedOrigins, frontendURL)
	}

	e.Use(middleware.CORSWithConfig(middleware.CORSConfig{
		AllowOrigins:     allowedOrigins,
		AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
		AllowHeaders:     []string{"*"},
		AllowCredentials: true,
	}))

	// Health endpoint
	e.GET("/health", handlers.Health)
	e.GET("/actuator/health", handlers.Health)

	// Example API route
	e.GET("/api/example", handlers.Example)

	// Protected API routes
<% if (modules.auth) { -%>
	// TODO: Add auth middleware
<% } -%>
	api := e.Group("/api")
	_ = api // Will be used for API routes

	port := os.Getenv("APP_PORT")
	if port == "" {
		port = "8080"
	}

	e.Logger.Printf("‚úÖ Server running on http://localhost:%s", port)
	e.Logger.Printf("üìç API available at http://localhost:%s/api", port)
	e.Logger.Printf("üè• Health check at http://localhost:%s/health", port)

	e.Logger.Fatal(e.Start(":" + port))
}
